const TelegramBot = require('node-telegram-bot-api');
const digiflazz = require('./digiflazz');
const express = require('express');

console.log("ü§ñ Starting Pulsa Telegram Bot with Custom SKUs...");

const token = process.env.TELEGRAM_TOKEN;
if (!token) {
    console.log("‚ùå ERROR: TELEGRAM_TOKEN not set");
    process.exit(1);
}

const bot = new TelegramBot(token, { polling: true });
const userStates = new Map();
const userData = new Map();

// PRODUCT MAP DENGAN SKU CUSTOM ANDA
const productMap = {
    // TELKOMSEL - menggunakan Tkl
    'telkomsel_5k': { code: 'Tkl5', name: 'Telkomsel 5.000', price: 6000 },
    'telkomsel_10k': { code: 'Tkl10', name: 'Telkomsel 10.000', price: 11000 },
    'telkomsel_25k': { code: 'Tkl25', name: 'Telkomsel 25.000', price: 26000 },
    'telkomsel_50k': { code: 'Tkl50', name: 'Telkomsel 50.000', price: 51000 },
    'telkomsel_100k': { code: 'Tkl100', name: 'Telkomsel 100.000', price: 101000 },
    
    // INDOSAT - menggunakan IND
    'indosat_5k': { code: 'IND5', name: 'Indosat 5.000', price: 6000 },
    'indosat_10k': { code: 'IND10', name: 'Indosat 10.000', price: 11000 },
    'indosat_25k': { code: 'IND25', name: 'Indosat 25.000', price: 26000 },
    'indosat_50k': { code: 'IND50', name: 'Indosat 50.000', price: 51000 },
    'indosat_100k': { code: 'IND100', name: 'Indosat 100.000', price: 101000 },
    
    // XL - menggunakan X
    'xl_5k': { code: 'X5', name: 'XL 5.000', price: 6000 },
    'xl_10k': { code: 'X10', name: 'XL 10.000', price: 11000 },
    'xl_25k': { code: 'X25', name: 'XL 25.000', price: 26000 },
    'xl_50k': { code: 'X50', name: 'XL 50.000', price: 51000 },
    'xl_100k': { code: 'X100', name: 'XL 100.000', price: 101000 },
    
    // AXIS - menggunakan Ax
    'axis_5k': { code: 'Ax5', name: 'Axis 5.000', price: 6000 },
    'axis_10k': { code: 'Ax10', name: 'Axis 10.000', price: 11000 },
    'axis_25k': { code: 'Ax25', name: 'Axis 25.000', price: 26000 },
    'axis_50k': { code: 'Ax50', name: 'Axis 50.000', price: 51000 },
    'axis_100k': { code: 'Ax100', name: 'Axis 100.000', price: 101000 }
};

console.log("‚úÖ Bot initialized with custom SKUs");

// ==================== BOT COMMANDS ====================

bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    userStates.set(chatId, 'main_menu');
    
    bot.sendMessage(chatId, `ü§ñ **TOKO PULSA DIGIFLAZZ**\n\nSelamat datang! Saya siap melayani pembelian pulsa dan paket data Anda.\n\nPilih menu di bawah:`, {
        parse_mode: 'Markdown',
        reply_markup: {
            keyboard: [
                ['üõí BELI PULSA', 'üì¶ PAKET DATA'],
                ['üìä CEK HARGA REAL', 'üë§ PROFIL'],
                ['üí≥ CEK SALDO', '‚ùì BANTUAN']
            ],
            resize_keyboard: true
        }
    });
});

// CEK HARGA REAL dari Digiflazz - FIXED VERSION
bot.onText(/üìä CEK HARGA REAL/, async (msg) => {
    const chatId = msg.chat.id;
    
    const loadingMsg = await bot.sendMessage(chatId, 'üîÑ Mengambil daftar harga terbaru dari Digiflazz...');
    
    try {
        const prices = await digiflazz.getPriceList();
        
        console.log('üîç Full Digiflazz Response:', JSON.stringify(prices, null, 2));
        
        if (prices && prices.success) {
            // ‚úÖ FIX: Handle berbagai format response Digiflazz
            let pulseProducts = [];
            
            if (Array.isArray(prices.data)) {
                pulseProducts = prices.data
                    .filter(p => p && (p.category === 'pulsa' || p.type === 'pulsa'))
                    .slice(0, 15);
            } else if (prices.data && typeof prices.data === 'object') {
                // Jika data berupa object, convert ke array
                pulseProducts = Object.values(prices.data)
                    .filter(p => p && (p.category === 'pulsa' || p.type === 'pulsa'))
                    .slice(0, 15);
            }
            
            console.log('üîç Filtered Products:', pulseProducts);
            
            if (pulseProducts.length > 0) {
                let message = 'üìã **DAFTAR HARGA PULSA REAL**\n\n';
                
                pulseProducts.forEach((product, index) => {
                    const productName = product.product_name || product.name || product.product_name_prepaid || 'Unknown Product';
                    const price = product.price || product.seller_price || 0;
                    const brand = product.brand || product.operator || 'Unknown';
                    
                    message += `üì± ${productName}\nüíµ Rp ${price.toLocaleString()}\nüè∑Ô∏è ${brand}\n`;
                    
                    if (index < pulseProducts.length - 1) message += '\n';
                });
                
                message += '\n_Data real-time dari Digiflazz_';
                
                await bot.editMessageText(message, {
                    chat_id: chatId,
                    message_id: loadingMsg.message_id,
                    parse_mode: 'Markdown'
                });
            } else {
                await bot.editMessageText('‚ùå Tidak ada produk pulsa ditemukan dalam response\n\nCoba cek struktur data Digiflazz.', {
                    chat_id: chatId,
                    message_id: loadingMsg.message_id
                });
            }
        } else {
            const errorMsg = prices?.error?.message || prices?.message || 'Unknown error';
            await bot.editMessageText(`‚ùå Response tidak valid dari Digiflazz:\n${errorMsg}`, {
                chat_id: chatId,
                message_id: loadingMsg.message_id
            });
        }
    } catch (error) {
        console.error('‚ùå Error in CEK HARGA REAL:', error);
        await bot.editMessageText(`‚ùå Terjadi error:\n${error.message}`, {
            chat_id: chatId,
            message_id: loadingMsg.message_id
        });
    }
});

// CEK SALDO DIGIFLAZZ
bot.onText(/üí≥ CEK SALDO/, async (msg) => {
    const chatId = msg.chat.id;
    
    const loadingMsg = await bot.sendMessage(chatId, 'üîÑ Mengecek saldo Digiflazz...');
    
    try {
        const balance = await digiflazz.checkBalance();
        
        if (balance.success) {
            await bot.editMessageText(`üí∞ **SALDO DIGIFLAZZ**\n\nüíµ Rp ${balance.balance.deposit.toLocaleString()}\n\n_Update: ${new Date().toLocaleTimeString('id-ID')}_`, {
                chat_id: chatId,
                message_id: loadingMsg.message_id,
                parse_mode: 'Markdown'
            });
        } else {
            await bot.editMessageText(`‚ùå Gagal cek saldo:\n${balance.error}`, {
                chat_id: chatId,
                message_id: loadingMsg.message_id
            });
        }
    } catch (error) {
        console.error('Error in CEK SALDO:', error);
        await bot.editMessageText(`‚ùå Error saat cek saldo:\n${error.message}`, {
            chat_id: chatId,
            message_id: loadingMsg.message_id
        });
    }
});

// BELI PULSA FLOW
bot.onText(/üõí BELI PULSA/, (msg) => {
    const chatId = msg.chat.id;
    userStates.set(chatId, 'waiting_phone');
    
    bot.sendMessage(chatId, 'üì± **MASUKKAN NOMOR HP**\n\nContoh: 081234567890\n\nPastikan nomor sudah benar!', {
        parse_mode: 'Markdown',
        reply_markup: {
            keyboard: [['üö´ BATAL']],
            resize_keyboard: true
        }
    });
});

// BATAL COMMAND
bot.onText(/üö´ BATAL/, (msg) => {
    const chatId = msg.chat.id;
    userStates.set(chatId, 'main_menu');
    
    bot.sendMessage(chatId, '‚ùå Transaksi dibatalkan.', {
        reply_markup: {
            keyboard: [
                ['üõí BELI PULSA', 'üì¶ PAKET DATA'],
                ['üìä CEK HARGA REAL', 'üë§ PROFIL']
            ],
            resize_keyboard: true
        }
    });
});

// HANDLE PHONE NUMBER INPUT
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    
    if (text.startsWith('/')) return;
    
    const state = userStates.get(chatId);
    
    if (!state) {
        userStates.set(chatId, 'main_menu');
        return;
    }
    
    if (['üõí BELI PULSA', 'üìä CEK HARGA REAL', 'üö´ BATAL', 'üì¶ PAKET DATA', 'üë§ PROFIL', 'üí≥ CEK SALDO', '‚ùì BANTUAN'].includes(text)) {
        return;
    }
    
    if (state === 'waiting_phone') {
        if (/^08[0-9]{9,12}$/.test(text)) {
            userData.set(chatId, { phone: text });
            userStates.set(chatId, 'waiting_operator');
            
            await bot.sendMessage(chatId, `üì± **NOMOR:** ${text}\n\nPilih operator:`, {
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [
                            { text: 'üì± TELKOMSEL', callback_data: 'operator_telkomsel' },
                            { text: 'üì± XL', callback_data: 'operator_xl' }
                        ],
                        [
                            { text: 'üì± INDOSAT', callback_data: 'operator_indosat' },
                            { text: 'üì± AXIS', callback_data: 'operator_axis' }
                        ],
                        [
                            { text: 'üö´ Batalkan', callback_data: 'cancel' }
                        ]
                    ]
                }
            });
        } else {
            await bot.sendMessage(chatId, '‚ùå Format nomor tidak valid!\n\nMasukkan nomor HP yang benar:\nContoh: 081234567890');
        }
    }
});

// HANDLE CALLBACK QUERIES (BUTTON CLICKS)
bot.on('callback_query', async (callbackQuery) => {
    const message = callbackQuery.message;
    const chatId = message.chat.id;
    const data = callbackQuery.data;
    
    await bot.answerCallbackQuery(callbackQuery.id);
    
    if (data === 'cancel') {
        userStates.set(chatId, 'main_menu');
        await bot.editMessageText('‚ùå Transaksi dibatalkan.', {
            chat_id: chatId,
            message_id: message.message_id
        });
        return;
    }
    
    // Handle operator selection
    if (data.startsWith('operator_')) {
        const operator = data.replace('operator_', '');
        const user = userData.get(chatId);
        
        if (user) {
            userData.set(chatId, { ...user, operator });
            userStates.set(chatId, 'waiting_amount');
            
            await bot.editMessageText(`üì± **NOMOR:** ${user.phone}\nüìû **OPERATOR:** ${operator.toUpperCase()}\n\nPilih nominal:`, {
                chat_id: chatId,
                message_id: message.message_id,
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [
                            { text: 'üí∞ 5.000', callback_data: `nominal_${operator}_5k` },
                            { text: 'üí∞ 10.000', callback_data: `nominal_${operator}_10k` }
                        ],
                        [
                            { text: 'üí∞ 25.000', callback_data: `nominal_${operator}_25k` },
                            { text: 'üí∞ 50.000', callback_data: `nominal_${operator}_50k` }
                        ],
                        [
                            { text: 'üí∞ 100.000', callback_data: `nominal_${operator}_100k` }
                        ],
                        [
                            { text: 'üö´ Batalkan', callback_data: 'cancel' }
                        ]
                    ]
                }
            });
        }
    }
    
    // Handle nominal selection
    if (data.startsWith('nominal_')) {
        const parts = data.replace('nominal_', '').split('_');
        const operator = parts[0];
        const nominal = parts[1];
        const productKey = `${operator}_${nominal}`;
        
        const selectedProduct = productMap[productKey];
        const user = userData.get(chatId);
        
        if (selectedProduct && user) {
            await bot.editMessageText(`‚úÖ **KONFIRMASI PEMESANAN**\n\nüì± Nomor: ${user.phone}\nüìû Operator: ${operator.toUpperCase()}\nüíµ Produk: ${selectedProduct.name}\nüí∞ Harga: Rp ${selectedProduct.price.toLocaleString()}\n\n‚ö†Ô∏è Pastikan data sudah benar!\nKetik ‚úÖ KONFIRMASI untuk melanjutkan`, {
                chat_id: chatId,
                message_id: message.message_id,
                parse_mode: 'Markdown'
            });
            
            userData.set(chatId, { 
                ...user, 
                productCode: selectedProduct.code,
                productName: selectedProduct.name,
                price: selectedProduct.price
            });
            userStates.set(chatId, 'waiting_confirmation');
        } else {
            await bot.editMessageText(`‚ùå Produk tidak tersedia: ${productKey}\n\nSilakan pilih operator dan nominal lain.`, {
                chat_id: chatId,
                message_id: message.message_id
            });
        }
    }
});

// Handle confirmation message
bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;
    const state = userStates.get(chatId);
    
    if (state === 'waiting_confirmation' && text === '‚úÖ KONFIRMASI') {
        const user = userData.get(chatId);
        
        if (user) {
            await bot.sendMessage(chatId, `üîÑ **MEMPROSES TRANSAKSI**\n\nüì± ${user.phone}\nüíµ ${user.productName}\nüí∞ Rp ${user.price.toLocaleString()}\n\nTunggu sebentar...`, {
                parse_mode: 'Markdown'
            });
            
            // Process real transaction dengan Digiflazz
            const result = await digiflazz.purchase(user.productCode, user.phone);
            
            if (result.success) {
                const transaction = result.data;
                await bot.sendMessage(chatId, `üéâ **TRANSAKSI BERHASIL!**\n\nüì± Nomor: ${user.phone}\nüíµ Produk: ${user.productName}\nüí∞ Harga: Rp ${user.price.toLocaleString()}\nüÜî Ref: ${result.refId}\nüì¶ SN: ${transaction.sn || 'N/A'}\n‚è±Ô∏è Status: ${transaction.status}\n\nTerima kasih telah berbelanja! üõçÔ∏è`, {
                    parse_mode: 'Markdown'
                });
            } else {
                await bot.sendMessage(chatId, `‚ùå **TRANSAKSI GAGAL**\n\nüì± ${user.phone}\nüíµ ${user.productName}\n\nError: ${result.error?.message || result.error || 'Unknown error'}\n\nSilakan coba lagi atau hubungi admin.`, {
                    parse_mode: 'Markdown'
                });
            }
            
            // Reset state
            userStates.set(chatId, 'main_menu');
            userData.delete(chatId);
        }
    }
});

// PROFIL COMMAND
bot.onText(/üë§ PROFIL/, (msg) => {
    const chatId = msg.chat.id;
    
    bot.sendMessage(chatId, `üë§ **PROFIL PENGGUNA**\n\nüÜî ID: ${msg.from.id}\nüìõ Nama: ${msg.from.first_name} ${msg.from.last_name || ''}\nü§ñ Username: @${msg.from.username || 'Tidak ada'}\n\nüìÖ Bergabung: ${new Date().toLocaleDateString('id-ID')}`, {
        parse_mode: 'Markdown'
    });
});

// BANTUAN COMMAND
bot.onText(/‚ùì BANTUAN/, (msg) => {
    const chatId = msg.chat.id;
    
    bot.sendMessage(chatId, `‚ùì **BANTUAN & PANDUAN**\n\nüîß **Cara penggunaan:**\n1. Pilih "Beli Pulsa"\n2. Masukkan nomor HP\n3. Pilih operator & nominal\n4. Konfirmasi pembelian\n\nüí∞ **Cek Saldo:** Gunakan menu "Cek Saldo"\nüìä **Harga Real:** Data langsung dari Digiflazz\n\nüìû **Support:** Hubungi admin untuk bantuan.\n\nüõ†Ô∏è **Status:** Bot Active ‚úÖ`, {
        parse_mode: 'Markdown'
    });
});

// PAKET DATA COMMAND
bot.onText(/üì¶ PAKET DATA/, (msg) => {
    const chatId = msg.chat.id;
    
    bot.sendMessage(chatId, `üì¶ **PAKET DATA**\n\nFitur paket data sedang dalam pengembangan.\n\nUntuk sementara, gunakan menu "Beli Pulsa" untuk pembelian pulsa reguler.`, {
        parse_mode: 'Markdown'
    });
});

// ERROR HANDLING
bot.on('polling_error', (error) => {
    console.log('‚ùå Polling Error:', error.message);
});

bot.on('webhook_error', (error) => {
    console.log('‚ùå Webhook Error:', error);
});

// ==================== EXPRESS SERVER FOR RENDER ====================
const app = express();
const PORT = process.env.PORT || 3000;

// Basic health check endpoint
app.get('/', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: 'Pulsa Telegram Bot is running!',
    timestamp: new Date().toISOString()
  });
});

// Health check untuk Render
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'healthy',
    service: 'Telegram Pulsa Bot',
    uptime: process.uptime()
  });
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`‚úÖ Server is running on port ${PORT}`);
  console.log(`‚úÖ Bot is live and ready!`);
});

console.log("‚úÖ Bot with Custom SKUs is running!");
