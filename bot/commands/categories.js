const BotProductService = require('../services/BotProductService');

// ‚úÖ FUNGSI UNTUK MEMFORMAT NAMA PRODUK
function formatProductName(name) {
    if (typeof name !== 'string') return name;
    
    // Ganti titik dengan koma (10.000 -> 10,000)
    return name.replace(/\./g, ',');
}

module.exports = (bot) => {
    console.log("üîÑ Loading categories command...");

    // Command /beli
    bot.onText(/\/beli/, async (msg) => {
        const chatId = msg.chat.id;
        showMainCategories(bot, chatId);
    });

    // Handler untuk tombol BELI
    bot.on('message', async (msg) => {
        if (!msg.text) return;
        
        const chatId = msg.chat.id;
        const text = msg.text;

        if (text === 'üì± BELI PULSA/DATA') {
            showMainCategories(bot, chatId);
        }
    });

    // Handler untuk callback queries (inline buttons) - ‚úÖ DIPERBAIKI
    bot.on('callback_query', async (callbackQuery) => {
        const msg = callbackQuery.message;
        const chatId = msg.chat.id;
        const messageId = msg.message_id;
        const data = callbackQuery.data;

        // ‚úÖ JAWAB SEGERA untuk mencegah timeout
        await bot.answerCallbackQuery(callbackQuery.id, { text: "‚è≥ Memuat..." });

        try {
            if (data.startsWith('category_')) {
                const category = data.replace('category_', '');
                await showSubCategories(bot, chatId, messageId, category);
            }
            else if (data.startsWith('subcategory_')) {
                const parts = data.replace('subcategory_', '').split('_');
                const category = parts[0];
                const subcategory = parts[1];
                
                console.log(`üîç Memproses subcategory: ${category} - ${subcategory}`);
                await showProducts(bot, chatId, messageId, category, subcategory);
            }
            else if (data.startsWith('product_')) {
                const productCode = data.replace('product_', '');
                await showProductDetail(bot, chatId, productCode);
            }
            else if (data === 'back_to_categories') {
                await showMainCategories(bot, chatId);
            }

        } catch (error) {
            console.error('Error in callback query:', error);
            
            // ‚úÖ ERROR HANDLING YANG LEBIH BAIK
            if (error.message && error.message.includes('query is too old')) {
                await bot.sendMessage(chatId, "‚ùå Sesi telah kadaluarsa. Silakan klik menu lagi.");
            } else {
                await bot.answerCallbackQuery(callbackQuery.id, { text: "‚ùå Terjadi kesalahan" });
            }
        }
    }); // ‚úÖ TAMBAHKAN KURUNG TUTUP INI

    console.log("‚úÖ Categories command loaded");

    // ‚úÖ TAMPILKAN KATEGORI UTAMA
    function showMainCategories(bot, chatId) {
        const message = `üõçÔ∏è **PILIH KATEGORI**

Silakan pilih kategori produk yang Anda butuhkan:`;

        const keyboard = {
            inline_keyboard: [
                [
                    { text: "üì± PULSA", callback_data: "category_pulsa" },
                    { text: "‚ö° PLN", callback_data: "category_pln" }
                ],
                [
                    { text: "üéÆ GAME", callback_data: "category_game" },
                    { text: "üì¶ PAKET DATA", callback_data: "category_data" }
                ],
                [
                    { text: "üí≥ E-WALLET", callback_data: "category_ewallet" },
                    { text: "üì∫ TV & INTERNET", callback_data: "category_tv" }
                ],
                [
                    { text: "üè† MENU UTAMA", callback_data: "back_to_main" }
                ]
            ]
        };

        bot.sendMessage(chatId, message, {
            parse_mode: 'Markdown',
            reply_markup: keyboard
        });
    }

    // ‚úÖ TAMPILKAN SUB-KATEGORI BERDASARKAN KATEGORI
    async function showSubCategories(bot, chatId, messageId, category) {
        let message = "";
        let subcategories = [];

        switch (category) {
            case 'pulsa':
                message = `üì± **PILIH OPERATOR PULSA**

Pilih operator yang diinginkan:`;
                subcategories = [
                    { name: "üì∂ AXIS", data: "axis" },
                    { name: "üîµ XL", data: "xl" },
                    { name: "üî¥ TELKOMSEL", data: "telkomsel" },
                    { name: "üü¢ INDOSAT", data: "indosat" },
                    { name: "üü° SMARTFREN", data: "smartfren" },
                    { name: "üü£ TRI", data: "tri" }
                ];
                break;

            case 'pln':
                message = `‚ö° **PRODUK PLN**

Pilih jenis produk PLN:`;
                subcategories = [
                    { name: "üí° PLN TOKEN", data: "token" },
                    { name: "üìã PLN TAGIHAN", data: "tagihan" }
                ];
                break;

            case 'game':
                message = `üéÆ **VOUCHER GAME**

Pilih game yang diinginkan:`;
                subcategories = [
                    { name: "üî• FREE FIRE", data: "ff" },
                    { name: "üéØ PUBG MOBILE", data: "pubg" },
                    { name: "‚öîÔ∏è MOBILE LEGENDS", data: "ml" },
                    { name: "üïπÔ∏è GARENA SHELLS", data: "shell" },
                    { name: "üéÆ STEAM WALLET", data: "steam" },
                    { name: "üëæ RAZER GOLD", data: "razer" }
                ];
                break;

            case 'data':
                message = `üì¶ **PAKET DATA**

Pilih operator untuk paket data:`;
                subcategories = [
                    { name: "üì∂ AXIS", data: "axis" },
                    { name: "üîµ XL", data: "xl" },
                    { name: "üî¥ TELKOMSEL", data: "telkomsel" },
                    { name: "üü¢ INDOSAT", data: "indosat" },
                    { name: "üü° SMARTFREN", data: "smartfren" }
                ];
                break;

            case 'ewallet':
                message = `üí≥ **E-WALLET & DIGITAL**

Pilih e-wallet yang diinginkan:`;
                subcategories = [
                    { name: "üü¢ GOPAY", data: "gopay" },
                    { name: "üîµ OVO", data: "ovo" },
                    { name: "üî¥ DANA", data: "dana" },
                    { name: "üü£ LINK AJA", data: "linkaja" },
                    { name: "üü† SHOPEEPAY", data: "shopeepay" }
                ];
                break;

            default:
                message = "‚ùå Kategori belum tersedia";
        }

        const keyboard = {
            inline_keyboard: [
                ...subcategories.map(sub => [{
                    text: sub.name,
                    callback_data: `subcategory_${category}_${sub.data}`
                }]),
                [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: "back_to_categories" }]
            ]
        };

        try {
            await bot.editMessageText(message, {
                chat_id: chatId,
                message_id: messageId,
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });
        } catch (error) {
            // Jika error edit, kirim message baru
            await bot.sendMessage(chatId, message, {
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });
        }
    }

    // ‚úÖ TAMPILKAN PRODUK BERDASARKAN KATEGORI & SUB-KATEGORI (DIPERBAIKI)
    async function showProducts(bot, chatId, messageId, category, subcategory) {
        try {
            // VALIDASI PARAMETER
            if (!subcategory) {
                console.error('‚ùå Subcategory is undefined!');
                return bot.editMessageText(
                    "‚ùå Kategori tidak valid. Silakan coba lagi.",
                    {
                        chat_id: chatId,
                        message_id: messageId,
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: "back_to_categories" }]
                            ]
                        }
                    }
                );
            }

            let products = [];
            let title = "";

            console.log(`üîç Mencari produk: ${category} - ${subcategory}`);

            // Ambil produk berdasarkan kategori
            if (category === 'pulsa') {
                const allProducts = await BotProductService.getPulsaProducts();
                console.log(`üì± Total produk pulsa: ${allProducts.length}`);
                
                products = allProducts.filter(p => 
                    p.operator && p.operator.toLowerCase() === subcategory.toLowerCase()
                );
                title = `üì± PULSA ${subcategory.toUpperCase()}`;
            } else {
                // Untuk kategori lain, gunakan method general
                products = await BotProductService.getProductsByCategory(category);
                console.log(`üì¶ Total produk ${category}: ${products.length}`);
                
                products = products.filter(p => 
                    p.subcategory && p.subcategory.toLowerCase() === subcategory.toLowerCase()
                );
                title = `üì¶ ${category.toUpperCase()} - ${subcategory.toUpperCase()}`;
            }

            console.log(`‚úÖ Produk ditemukan: ${products.length} untuk ${subcategory}`);

            if (products.length === 0) {
                return bot.editMessageText(
                    `‚ùå Tidak ada produk untuk ${subcategory.toUpperCase()}\n\nSilakan pilih kategori lain.`,
                    {
                        chat_id: chatId,
                        message_id: messageId,
                        reply_markup: {
                            inline_keyboard: [
                                [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: `category_${category}` }]
                            ]
                        }
                    }
                );
            }

            let message = `${title}\n\n`;
            
            // ‚úÖ GUNAKAN formatProductName UNTUK MENGATASI ERROR MARKDOWN
            products.forEach((product, index) => {
                const displayName = formatProductName(product.name);
                message += `${index + 1}. ${displayName}\n`;
                message += `   üí∞ Rp ${product.price.toLocaleString('id-ID')}\n`;
                message += `   üÜî Kode: \`${product.code}\`\n\n`;
            });

            message += "üí° **Cara Order:**\n";
            message += "`/order [kode] [nomor]`\n";
            message += "Contoh: `/order AX10 08123456789`";

            const keyboard = {
                inline_keyboard: [
                    [{ text: "üîÑ REFRESH", callback_data: `subcategory_${category}_${subcategory}` }],
                    [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: `category_${category}` }]
                ]
            };

            await bot.editMessageText(message, {
                chat_id: chatId,
                message_id: messageId,
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });

        } catch (error) {
            console.error('Error showing products:', error);
            await bot.editMessageText(
                "‚ùå Gagal memuat produk. Silakan coba lagi.",
                {
                    chat_id: chatId,
                    message_id: messageId,
                    reply_markup: {
                        inline_keyboard: [
                            [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: "back_to_categories" }]
                        ]
                    }
                }
            );
        }
    }

    // ‚úÖ TAMPILKAN DETAIL PRODUK (DIPERBAIKI)
    async function showProductDetail(bot, chatId, productCode) {
        try {
            const product = await BotProductService.findProductForBot(productCode);
            
            if (!product) {
                return bot.sendMessage(chatId, "‚ùå Produk tidak ditemukan.");
            }

            // ‚úÖ GUNAKAN formatProductName JUGA DI SINI
            const displayName = formatProductName(product.name);

            const message = `üì¶ **DETAIL PRODUK**

üè∑Ô∏è **Nama:** ${displayName}
üí∞ **Harga:** Rp ${product.price.toLocaleString('id-ID')}
üÜî **Kode:** \`${product.code}\`
üìä **Kategori:** ${product.category || 'Umum'}
üè¢ **Operator:** ${product.operator || '-'}

üí° **Cara Order:**
\`/order ${product.code} [nomor_tujuan]\`

Contoh:
\`/order ${product.code} 08123456789\``;

            const keyboard = {
                inline_keyboard: [
                    [{ text: "üì¶ ORDER SEKARANG", callback_data: `order_${product.code}` }],
                    [{ text: "‚¨ÖÔ∏è KEMBALI", callback_data: "back_to_categories" }]
                ]
            };

            await bot.sendMessage(chatId, message, {
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });

        } catch (error) {
            console.error('Error showing product detail:', error);
            bot.sendMessage(chatId, "‚ùå Gagal memuat detail produk.");
        }
    }
}; // ‚úÖ TAMBAHKAN KURUNG TUTUP UNTUK module.exports